<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>QR Attendance Scanner</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { font-family: Arial; text-align: center; padding: 20px; }
    #reader { width: 300px; margin: 20px auto; }
    #scannedText, #manualInput { background: #f0f0f0; padding: 10px; border: 1px solid #ccc; max-width: 300px; margin: 10px auto; word-wrap: break-word; }
    select, button { padding: 8px 16px; margin: 5px; }
    #status { font-weight: bold; color: green; }
  </style>
</head>
<body>
  <h2>ğŸ“¸ QR Attendance Scanner</h2>
  <div id="reader"></div>
  <pre id="scannedText">No scan yet...</pre>

  <label for="yearLevel">Select Year Level:</label>
  <select id="yearLevel">
    <option value="">-- Select --</option>
    <option value="1st Year">1st Year</option>
    <option value="2nd Year">2nd Year</option>
    <option value="3rd Year">3rd Year</option>
    <option value="4th Year">4th Year</option>
  </select><br>
  <button onclick="submitAttendance()" id="submitBtn" disabled>ğŸ“¤ Confirm & Send</button>

  <p id="status">Waiting for scan...</p>

  <hr>
  <h3>ğŸ“‹ Manual Input</h3>
  <textarea id="manualInput" placeholder="Paste QR data here..." rows="4" cols="40"></textarea><br>
  <button onclick="submitManualInput()">ğŸ“¤ Submit Manual</button>

  <script>
    const endpoint = "https://script.google.com/macros/s/AKfycbxf-xBgYbyQDA6VbGxdbRzHt6UWJSP3jACxYct3vJHbvexSs_0NhZFGd0_QCITZRblh/exec";
    const scanner = new Html5Qrcode("reader");
    let lastScanned = "";

    function sendToScript(data) {
      fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "text/plain" },
        body: data
      }).then(res => res.text())
        .then(msg => {
          document.getElementById("status").innerText = msg;
          document.getElementById("submitBtn").disabled = true;
          document.getElementById("scannedText").innerText = "No scan yet...";
        }).catch(() => {
          document.getElementById("status").innerText = "âŒ Failed to send";
        });
    }

    function submitAttendance() {
      const yearLevel = document.getElementById("yearLevel").value;
      if (!lastScanned || !yearLevel) return alert("Scan a code and select year level.");
      sendToScript(`${lastScanned}|YEARLEVEL=${yearLevel}`);
    }

    function submitManualInput() {
      const text = document.getElementById("manualInput").value.trim();
      const yearLevel = document.getElementById("yearLevel").value;
      if (!text || !yearLevel) return alert("Provide data + year level.");
      sendToScript(`${text}|YEARLEVEL=${yearLevel}`);
      document.getElementById("manualInput").value = "";
    }

    function onScanSuccess(decodedText) {
      lastScanned = decodedText;
      document.getElementById("scannedText").innerText = decodedText;
      document.getElementById("submitBtn").disabled = false;
      document.getElementById("status").innerText = "âœ… QR scanned. Select year level.";
    }

    Html5Qrcode.getCameras().then(devices => {
  if (devices.length) {
    // Try to find a back-facing camera
    const backCam = devices.find(device =>
      device.label.toLowerCase().includes("back") ||
      device.label.toLowerCase().includes("rear")
    ) || devices[0]; // fallback to first camera

    scanner.start(
      { deviceId: { exact: backCam.id } },
      { fps: 10, qrbox: 250 },
      onScanSuccess
    );
  } else {
    document.getElementById("status").innerText = "âŒ No camera found.";
  }
});

  </script>
</body>
</html>
