<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>QR Attendance Scanner</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
 <style>
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    text-align: center;
  }
  #reader {
    width: 90%;
    max-width: 600px;
    margin: auto;
    border: 2px solid #ccc;
    border-radius: 10px;
  }
  #status {
    font-weight: bold;
    color: green;
    margin-top: 10px;
  }
  #scannedText {
    background: #f0f0f0;
    padding: 10px;
    border: 1px solid #ccc;
    max-width: 90%;
    margin: auto;
    word-wrap: break-word;
    font-size: 14px;
  }
  #scan-again-btn {
    display: none;
    margin-top: 15px;
    padding: 10px 20px;
    font-size: 16px;
    cursor: pointer;
  }
</style>

</head>
<body>
  <h2>üì∏ QR Attendance Scanner</h2>

  <div id="reader"></div>

  <p><strong>Scanned Content:</strong></p>
  <pre id="scannedText">No scan yet...</pre>

  <p id="status">Waiting for scan...</p>

  <button id="scan-again-btn" onclick="restartScanner()">üîÑ Scan Again</button>

  <script>
    const sheetWebhookURL = "https://script.google.com/macros/s/AKfycbzbdgtEjSDtc3SstJKi289qRr94What-aHKeaNURhn04aUngo_DQ28jCxSjQUZ_HCbEMg/exec";

    let scanner;
    let isScanning = true;

    function sendToSheet(data) {
      fetch(sheetWebhookURL, {
        method: "POST",
        body: data,
        headers: {
          "Content-Type": "text/plain"
        }
      })
      .then(res => res.text())
      .then(msg => {
        document.getElementById("status").innerText = msg;
        document.getElementById("scan-again-btn").style.display = "inline-block";
      })
      .catch(err => {
        document.getElementById("status").innerText = "‚ùå Failed to log attendance";
      });
    }

    function onScanSuccess(decodedText, decodedResult) {
      if (!isScanning) return;
      isScanning = false; // prevent further scans

      document.getElementById("scannedText").innerText = decodedText;
      document.getElementById("status").innerText = "‚è≥ Sending...";
      scanner.stop().then(() => {
        sendToSheet(decodedText);
      });
    }

    const html5QrCode = new Html5Qrcode("reader");

    function startScanner() {
      isScanning = true;
      html5QrCode.start(
        { facingMode: "environment" },
        {
          fps: 10,
          qrbox: { width: 500, height: 500 }
        },
        onScanSuccess
      ).then(s => {
        scanner = html5QrCode;
      }).catch(err => {
        document.getElementById("status").innerText = "‚ùå Camera error: " + err;
      });
    }

    function restartScanner() {
      document.getElementById("scannedText").innerText = "No scan yet...";
      document.getElementById("status").innerText = "Waiting for scan...";
      document.getElementById("scan-again-btn").style.display = "none";
      startScanner();
    }

    // Start for the first time
    startScanner();
  </script>
</body>
</html>
